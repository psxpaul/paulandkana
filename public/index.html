<html>
  <head>
    <title>See comments/Post a comment here</title>
    <link rel="stylesheet" href="/stylesheets/style.css" type="text/css" media="screen" />

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="/javascripts/jquery.cookie.js"></script>
    <script type="text/javascript" src="/javascripts/slideshow.js"></script>

    <script type="text/javascript">
        function populateComments() {
            var commentsDiv = $("#comments").empty();
            $("input[type=text],textarea").val("");

            $.ajax({
                url: "/comments",
                type: "GET",
                cache: false,
                success: function(data) {
                    $.each(data, function(i, item) {
                        $("<input class='commentAuthor' readonly='readonly' />").val(item.author).appendTo(commentsDiv);
                        $("<textarea class='commentText' rows='5' cols='100' readonly='readonly' />").val(item.text).appendTo(commentsDiv);
                    });
                }
            });
        }

        function showForGuest(guest) {
            var usersName = guest.nameTwo ? guest.nameOne + " and " + guest.nameTwo : guest.nameOne;

            $("a[href=#rsvpdTab]").hide();
            $("a[href=#authenticationTab]").hide();
            $("a[href=#authenticatedTab]").show();

            $("#greeting").text("Hello " + usersName + "! You may now RSVP for our wedding! Sooo....");

            if (guest.rsvpChanges && guest.rsvpChanges.length) {
                $("a[href=#rsvpdTab]").show();
                $("a[href=#authenticatedTab]").hide();
            }
        }

        function showForAnonymous() {
            $("a[href=#rsvpdTab]").hide();
            $("a[href=#authenticatedTab]").hide();
            $("a[href=#authenticationTab]").show();
            $("a[href=#authenticationInput]").val("");
        }

        $(document).ready(function() {
            populateComments();

            if($.cookie("authentication")) {
                $.ajax({
                    url: "/whoami",
                    type: "GET",
                    cache: false,
                    error: function (jqXHR, textStatus, errorThrown) {
                        $.cookie("authentication", null);
                        showForAnonymous();
                    },
                    success: showForGuest
                });
            } else {
                showForAnonymous();
            }

            $("#newCommentForm").submit(function() {
                $("#commentSubmit").blur();
                $("#commentError").empty();

                $.ajax({
                    url: "/comment",
                    type: "POST",
                    data: $(this).serialize(),
                    success: populateComments,
                    error: function(jqxhr, textStatus, errorThrown) {
                      $("#commentError").text("Error: " + jqxhr.responseText);
                      }
                });
            });

            $("#authenticationForm").submit(function() {
                $("#authenticationSubmit").blur();
                $("#authenticationError").empty();

                $.ajax({
                    url: "/authenticate",  
                    contentType: "text/plain",
                    type: "POST",
                    processData: false,
                    data: $(this).find("input[type=text]").val(),
                    success: function (data) {
                        showForGuest(data);
                        $("a[href=#authenticatedTab]").click();
                    },
                    error: function(jqxhr) {
                        $("#authenticationError").text("Error: " + jqxhr.responseText);
                    }
                });
            });

            $("#rsvpForm").submit(function() {
                $("#rsvpSubmit").attr("disabled", "disabled").blur();

                $.ajax({
                    url: "/rsvp",
                    type: "POST",
                    data: $(this).serialize(),
                    success: function(data) {
                        $("#rsvpdTab").show();
                        $("#authenticatedTab").hide();
                        $("#authenticationTab").hide();
                    },
                    error: function(jqxhr) {
                        console.log("error RSVPing: " + jqxhr.responseText);
                    }
                });
            });

            $("#deauthenticate").click(function() {
                $.cookie("authentication", null);
                showForAnonymous();
                $("a[href=#slideshowTab]").click();
                return false;
            });

            $("#unrsvp").click(function() {
                $("#rsvpdTab").hide();
                $("#authenticatedTab").show();
                $("#authenticationTab").hide();
                $("#rsvpSubmit").removeAttr("disabled");
                return false;
            });

            SlideShow({
                parent: $("#slideshow"),
                images: [
                    "/images/slideshow_1.jpg",
                    "/images/slideshow_2.jpg",
                    "/images/slideshow_3.jpg"
                ]
            });

            $("#tabList").children().click(function () {
                $(".tab").hide();
                $($(this).attr("href")).show();
                $(this).addClass("buttonSelected").siblings().removeClass("buttonSelected");
                return false;
            }).first().click();

            $("a[href=" + window.location.hash + "]").click();
        });
    </script>
  </head>
  <body>
    <div id="tabList">
      <a class="button" href="#slideshowTab">Photos</a>
      <a class="button" href="#commentsTab">Guest Book</a>
      <a class="button" href="#authenticationTab">RSVP</a>
      <a class="button" href="#rsvpdTab">RSVP</a>
      <a class="button" href="#authenticatedTab">About the Ceremony</a>
    </div>

    <div id="slideshowTab" class="tab">
      <div id="slideshow"></div>
    </div>

    <div id="commentsTab" class="tab">
      <div id="comments"></div>

      <div id="newComment">New comment form:
        <span id="commentError" style="color:red;"></span>
        <form id="newCommentForm" method="" enctype="multipart/form-data" action="#" target="postFrame">
          <label for="author">Author: </label>
          <input type="text" name="author"/>
          <br/>

          <label for="text">Content: </label>
          <br/>
          <textarea rows="5" cols="100" name="text"></textarea>
          <br/>
          <input id="commentSubmit" type="submit"/>
        </form>
      </div>
    </div>

    <div id="authenticationTab" class="tab">
      <span id="authenticationError" style="color:red;"></span>
      <form id="authenticationForm" method="" enctype="multipart/form-data" action="#" target="postFrame">
        <label for="authenticationInput">Invitation Code: </label>
        <input id="authenticationInput" type="text" name="key"/>
        <input id="authenticationSubmit" type="submit" value="RSVP"/>
      </form>
    </div>

    <div id="authenticatedTab" class="tab">
      <span id="greeting"></span>
      <form id="rsvpForm" method="" enctype="multipart/form-data" action="#" target="postFrame">
        <span>Are You coming?</span>
        <br/>

        <input type="radio" id="comingYes" name="coming" value="yes"/>
        <label for="comingYes">Yes</label>
        <br/>

        <input type="radio" id="comingNo" name="coming" value="no"/>
        <label for="comingNo">No</label>
        <br/>

        <input id="rsvpSubmit" type="submit" value="RSVP" />
      </form>

      <br/><a id="deauthenticate" href="#">This is not me!</a>
    </div>

    <div id="rsvpdTab" class="tab">
      <span>Thank you for RSVPing! If you would like to change your status, please click <a id="unrsvp" href="#">here</a></span>
    </div>

    <iframe name="postFrame"></iframe>
  </body>
</html>
