<html>
  <head>
    <title>See comments/Post a comment here</title>
    <link rel="stylesheet" href="/stylesheets/style.css" type="text/css" media="screen" />

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="/javascripts/jquery.cookie.js"></script>
    <script type="text/javascript">
        function populateComments() {
            var commentsDiv = $("#comments").empty();
            $("input[type=text],textarea").val("");

            $.ajax({
                url: "/comments",
                type: "GET",
                cache: false,
                success: function(data) {
                    $.each(data, function(i, item) {
                        $("<input class='commentAuthor' readonly='readonly' />").val(item.author).appendTo(commentsDiv);
                        $("<textarea class='commentText' rows='5' cols='100' readonly='readonly' />").val(item.text).appendTo(commentsDiv);
                    });
                }
            });
        }

        function showForGuest(guest) {
            var usersName = guest.nameTwo ? guest.nameOne + " and " + guest.nameTwo : guest.nameOne;

            $("#rsvpd").hide();
            $("#authentication").hide();
            $("#authenticated").show();
            $("#greeting").text("Hello " + usersName + "! You may now RSVP for our wedding! Sooo....");

            if (guest.rsvpChanges && guest.rsvpChanges.length) {
                $("#rsvpd").show();
                $("#authenticated").hide();
            }
        }

        $(document).ready(function() {
            populateComments();

            if($.cookie("authentication")) {
                $.ajax({
                    url: "/whoami",
                    type: "GET",
                    cache: false,
                    success: showForGuest
                });
            } else {
                $("#rsvpd").hide();
                $("#authenticated").hide();
                $("#authentication").show();
            }

            $("#newCommentForm").submit(function() {
                $("#commentSubmit").blur();
                $("#commentError").empty();

                $.ajax({
                    url: "/comment",
                    type: "POST",
                    data: $(this).serialize(),
                    success: populateComments,
                    error: function(jqxhr, textStatus, errorThrown) {
                      $("#commentError").text("Error: " + jqxhr.responseText);
                      }
                });
            });

            $("#authenticationForm").submit(function() {
                $("#authenticationSubmit").blur();
                $("#authenticationError").empty();

                $.ajax({
                    url: "/authenticate",  
                    type: "POST",
                    data: $(this).serialize(),
                    success: showForGuest,
                    error: function(jqxhr) {
                        $("#authenticationError").text("Error: " + jqxhr.responseText);
                    }
                });
            });

            $("#rsvpForm").submit(function() {
                $("#rsvpSubmit").attr("disabled", "disabled").blur();

                $.ajax({
                    url: "/rsvp",
                    type: "POST",
                    data: $(this).serialize(),
                    success: function(data) {
                        $("#rsvpd").show();
                        $("#authenticated").hide();
                        $("#authentication").hide();
                    },
                    error: function(jqxhr) {
                        console.log("error RSVPing: " + jqxhr.responseText);
                    }
                });
            });

            $("#deauthenticate").click(function() {
                $.cookie("authentication", null);
                $("#rsvpd").hide();
                $("#authenticated").hide();
                $("#authenticationInput").val("");
                $("#authentication").show();
                return false;
            });

            $("#unrsvp").click(function() {
                $("#rsvpd").hide();
                $("#authenticated").show();
                $("#authentication").hide();
                $("#rsvpSubmit").removeAttr("disabled");
                return false;
            });
        });
    </script>
  </head>
  <body>
    <div id="comments"></div>

    <div id="newComment">New comment form:
      <span id="commentError" style="color:red;"></span>
      <form id="newCommentForm" method="post" enctype="multipart/form-data" action="#" target="postFrame">
          <label for="author">Author: </label>
          <input type="text" name="author"/>
          <br/>

          <label for="text">Content: </label>
          <br/>
          <textarea rows="5" cols="100" name="text"></textarea>
          <br/>
          <input id="commentSubmit" type="submit"/>
      </form>
    </div>

    <br/><br/><br/><br/>

    <div id="authentication">
      <span id="authenticationError" style="color:red;"></span>
      <form id="authenticationForm" method="post" enctype="multipart/form-data" action="#" target="postFrame">
        <label for="authenticationInput">Invitation Code: </label>
        <input id="authenticationInput" type="text" name="key"/>
        <input id="authenticationSubmit" type="submit" value="RSVP"/>
      </form>
    </div>

    <div id="authenticated">
      <span id="greeting"></span>
      <form id="rsvpForm" method="post" enctype="multipart/form-data" action="#" target="postFrame">
        <span>Are You coming?</span>
        <br/>

        <input type="radio" id="comingYes" name="coming" value="yes"/>
        <label for="comingYes">Yes</label>
        <br/>

        <input type="radio" id="comingYesPlusOne" name="coming" value="yesPlusOne"/>
        <label for="comingYesPlusOne">Yes, plus one!</label>
        <br/>

        <input type="radio" id="comingNo" name="coming" value="no"/>
        <label for="comingNo">No</label>
        <br/>

        <input id="rsvpSubmit" type="submit" value="RSVP" />
      </form>

      <br/><a id="deauthenticate" href="#">This is not me!</a>
    </div>

    <div id="rsvpd">
      <span>Thank you for RSVPing! If you would like to change your status, please click <a id="unrsvp" href="#">here</a></span>
    </div>

    <iframe name="postFrame"></iframe>
  </body>
</html>
